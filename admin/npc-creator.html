<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NPC Creator â€“ Next Quest Studios</title>
  <link rel="stylesheet" href="css/admin.css" />
  <script type="module" src="/public/shared/firebaseConfig.js"></script>
</head>
<body>
  <div class="tool-container">
    <h2>NPC Creator</h2>

    <label for="npcName">NPC Name:</label>
    <input type="text" id="npcName" placeholder="Enter NPC name" />

    <label for="npcSprite">Select Sprite:</label>
    <select id="npcSprite">
      <option value="">Loading sprites...</option>
    </select>

    <label for="npcDialog">Dialog Lines (separated by semicolons):</label>
    <textarea id="npcDialog" rows="3" placeholder="e.g. Hello; Welcome to our village; Stay safe out there!"></textarea>

    <label for="npcBehavior">Behavior:</label>
    <select id="npcBehavior">
      <option value="static">Static</option>
      <option value="wander">Wander</option>
      <option value="merchant">Merchant</option>
      <option value="quest">Quest Giver</option>
    </select>

    <button id="saveNpcBtn">Save NPC</button>
    <p id="statusMsg"></p>
  </div>

  <script type="module">
    import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    const db = getFirestore();

    const spriteSelect = document.getElementById("npcSprite");
    const saveNpcBtn = document.getElementById("saveNpcBtn");
    const statusMsg = document.getElementById("statusMsg");

    // Load sprites into dropdown
    async function loadSprites() {
      const snapshot = await getDocs(collection(db, "sprites"));
      spriteSelect.innerHTML = `<option value="">-- Select Sprite --</option>`;
      snapshot.forEach(doc => {
        const data = doc.data();
        spriteSelect.innerHTML += `<option value="${data.url}">${data.name}</option>`;
      });
    }

    loadSprites();

    saveNpcBtn.addEventListener("click", async () => {
      const name = document.getElementById("npcName").value.trim();
      const sprite = document.getElementById("npcSprite").value;
      const dialogRaw = document.getElementById("npcDialog").value.trim();
      const behavior = document.getElementById("npcBehavior").value;

      if (!name || !sprite) {
        statusMsg.textContent = "Please enter an NPC name and select a sprite.";
        return;
      }

      const dialogLines = dialogRaw.split(";").map(line => line.trim()).filter(Boolean);

      const npc = {
        name,
        sprite,
        dialog: dialogLines,
        behavior,
        createdAt: Date.now()
      };

      try {
        await addDoc(collection(db, "npcs"), npc);
        statusMsg.textContent = "NPC saved successfully!";
      } catch (err) {
        statusMsg.textContent = "Error: " + err.message;
      }
    });
  </script>
</body>
</html>